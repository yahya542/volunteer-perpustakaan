<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Library Dashboard</h1>
    
    <div class="container">
        <div style="text-align: right; margin-bottom: 20px;">
            <span id="user-info"></span>
            <button id="logout-btn" style="display: none;" onclick="logout()">Logout</button>
        </div>
        
        <h2>Menu</h2>
        <div class="menu-container">
            <button class="menu-button" onclick="loadAccountInfo()">Akun Saya</button>
            <button class="menu-button" onclick="loadLoanHistory()">Sejarah Peminjaman</button>
            <button class="menu-button" onclick="loadCurrentLoans()">Peminjaman Saat Ini</button>
            <button class="menu-button" onclick="loadLoanExtensionPage()">Ajukan Perpanjangan</button>
            <button class="menu-button" onclick="loadAllBooks()">Lihat Semua Buku</button>
        </div>
        
        <div id="status-message" style="margin: 10px 0; padding: 10px; border-radius: 5px; display: none;"></div>
        <div id="data-display" style="margin-top: 20px;"></div>
        <!-- Add dedicated containers for each section -->
        <div id="account-result" style="margin-top: 20px; display: none;"></div>
        <div id="loan-history" style="margin-top: 20px; display: none;"></div>
        <div id="current-loans-result" style="margin-top: 20px; display: none;"></div>
        <div id="books-result" style="margin-top: 20px; display: none;"></div>
        <div id="book-detail" style="margin-top: 20px; display: none;"></div>
    </div>

    <script>
        const baseUrl = 'http://localhost:8000';
        
        // Utility function to parse JWT token
        function parseJwt(token) {
            try {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                return JSON.parse(atob(base64));
            } catch (error) {
                console.error('Error parsing JWT token:', error);
                return null;
            }
        }
        
        // Get member ID from JWT token
        function getMemberIdFromToken() {
            const token = localStorage.getItem('access_token');
            if (!token) return null;
            
            const decoded = parseJwt(token);
            if (!decoded || !decoded.user_id) return null;
            
            return decoded.user_id;
        }
        
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('=== Page Load Debug ===');
            console.log('All localStorage items:');
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                console.log(key + ':', localStorage.getItem(key));
            }
            
            // Get member ID from JWT token
            const memberId = getMemberIdFromToken();
            console.log('Member ID from JWT:', memberId);
            
            const token = localStorage.getItem('access_token');
            if (!token) {
                // Redirect to login page if not authenticated
                console.log('No token found, redirecting to login');
                window.location.href = 'login.html';
                return;
            }
            
            // Show user info and logout button
            const username = localStorage.getItem('username');
            
            document.getElementById('user-info').textContent = `Logged in as: ${username}`;
            document.getElementById('logout-btn').style.display = 'inline-block';
        });
        
        // Logout function
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('username');
            localStorage.removeItem('user_id');
            localStorage.removeItem('user_type');
            window.location.href = 'login.html';
        }

        // Function to show status messages
        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            statusDiv.style.backgroundColor = isError ? '#ffebee' : '#e8f5e9';
            statusDiv.style.border = `1px solid ${isError ? '#ffcdd2' : '#c8e6c9'}`;
            statusDiv.style.color = isError ? '#c62828' : '#2e7d32';
        }

        // Function to show/hide sections
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(section => {
                section.style.display = 'none';
            });
            
            // Show the requested section
            const section = document.getElementById(sectionId);
            if (section) {
                section.style.display = 'block';
            }
            
            // Clear previous results when switching sections
            document.getElementById('account-result').innerHTML = '';
            document.getElementById('loan-history').innerHTML = '';
            document.getElementById('current-loans-result').innerHTML = '';
            document.getElementById('books-result').innerHTML = '';
            document.getElementById('book-detail').innerHTML = '';
        }
        
        // Function to navigate to loan extension page
        function loadLoanExtensionPage() {
            window.location.href = 'loan-extension.html';
        }
        
        // Event listeners for navigation buttons
        document.addEventListener('DOMContentLoaded', function() {
            
            document.getElementById('loan-history-btn').addEventListener('click', function() {
                showSection('loan-history-section');
                loadLoanHistory();
            });
            document.getElementById('current-loans-btn').addEventListener('click', function() {
                showSection('current-loans-section');
                loadCurrentLoans();
            });
            document.getElementById('all-books-btn').addEventListener('click', function() {
                showSection('all-books-section');
                loadAllBooks();
            });
        });
        
        // Clean up any old localStorage items that are no longer needed
        function cleanupOldLocalStorage() {
            localStorage.removeItem('user_id'); // Not needed anymore since we get it from JWT
        }
        
        // Call cleanup when page loads
        cleanupOldLocalStorage();

        // Load account information
        function loadAccountInfo() {
            console.log('=== Load Account Info Debug ===');
            
            const token = localStorage.getItem('access_token');
            console.log('Token:', token);
            
            // Get member ID from JWT token instead of localStorage
            const memberId = getMemberIdFromToken();
            console.log('Member ID from JWT:', memberId);
            
            if (!memberId) {
                console.log('No member_id found in JWT token');
                document.getElementById('account-result').innerHTML = '<p>Error: Unable to retrieve member information. Please try logging in again.</p>';
                return;
            }
            
            console.log('Using member ID from JWT for account info request');
            
            fetch(`${baseUrl}/user/members/${memberId}/`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Account data received:', data);
                document.getElementById('data-display').innerHTML = `
                    <div class="result-card">
                        <h3>Account Information</h3>
                        <table class="result-table">
                            <tr><td><strong>Member ID:</strong></td><td>${data.member_id || 'N/A'}</td></tr>
                            <tr><td><strong>Name:</strong></td><td>${data.member_name || 'N/A'}</td></tr>
                            <tr><td><strong>Email:</strong></td><td>${data.member_email || 'N/A'}</td></tr>
                            <tr><td><strong>Phone:</strong></td><td>${data.member_phone || 'N/A'}</td></tr>
                            <tr><td><strong>Address:</strong></td><td>${data.member_address || 'N/A'}</td></tr>
                            <tr><td><strong>Member Since:</strong></td><td>${data.member_since_date || 'N/A'}</td></tr>
                            <tr><td><strong>Registration Date:</strong></td><td>${data.register_date || 'N/A'}</td></tr>
                            <tr><td><strong>Expiration Date:</strong></td><td>${data.expire_date || 'N/A'}</td></tr>
                        </table>
                    </div>
                `;
            })
            .catch(error => {
                console.error('Error loading account info:', error);
                document.getElementById('account-result').innerHTML = `<p>Error loading account information: ${error.message}</p>`;
            });
        }

        // Load loan history
        function loadLoanHistory() {
            console.log('=== Load Loan History Debug ===');
            
            const token = localStorage.getItem('access_token');
            console.log('Token:', token);
            
            if (!token) {
                console.log('No token found');
                document.getElementById('loan-history').innerHTML = '<p>Error: Authentication required. Please log in again.</p>';
                return;
            }
            const memberId = getMemberIdFromToken();
            console.log('Member ID from JWT:', memberId);

            if (!memberId) {
                document.getElementById('loan-history').innerHTML =
                    '<p>Error: Member ID tidak valid. Silakan login ulang.</p>';
                return;
            }


            
            console.log('Fetching loan history with JWT token');
            
            // Fetch loan history data - using the correct endpoint without member ID
            const url = `${baseUrl}/api/loan-history/member/${memberId}/`;
            console.log('Fetching loan history from:', url);
            
            fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('Loan history API Response status:', response.status);
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Unauthorized: Please log in again');
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Loan history data received:', data);
                if (data && data.length > 0) {
                    // Create HTML table for loan history
                    let tableHtml = `
                        <div class="result-card">
                            <h3>Loan History</h3>
                            <table class="result-table">
                                <thead>
                                    <tr>
                                        <th>Item Code</th>
                                        <th>Title</th>
                                        <th>Loan Date</th>
                                        <th>Due Date</th>
                                        <th>Return Date</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    data.forEach(item => {
                        tableHtml += `
                            <tr>
                                <td>${item.item_code || 'N/A'}</td>
                                <td>${item.title || 'N/A'}</td>
                                <td>${item.loan_date || 'N/A'}</td>
                                <td>${item.due_date || 'N/A'}</td>
                                <td>${item.return_date || 'Not returned'}</td>
                            </tr>
                        `;
                    });
                    
                    tableHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    // Make sure the element exists before trying to set innerHTML
                    const container = document.getElementById('loan-history');
                    if (container) {
                        container.innerHTML = tableHtml;
                        container.style.display = 'block';
                        document.getElementById('data-display').innerHTML = ''; // Clear main display
                    } else {
                        console.warn('loan-history element not found');
                        // Fallback to main display
                        document.getElementById('data-display').innerHTML = tableHtml;
                    }
                } else {
                    const container = document.getElementById('loan-history');
                    if (container) {
                        container.innerHTML = '<p>No loan history found.</p>';
                        container.style.display = 'block';
                    } else {
                        document.getElementById('data-display').innerHTML = '<p>No loan history found.</p>';
                    }
                }
            })
            .catch(error => {
                console.error('Error loading loan history:', error);
                const container = document.getElementById('loan-history');
                if (container) {
                    container.innerHTML = `<p>Error loading loan history: ${error.message}</p>`;
                    container.style.display = 'block';
                } else {
                    document.getElementById('data-display').innerHTML = `<p>Error loading loan history: ${error.message}</p>`;
                }
            });
        }

        // Load current loans
        function loadCurrentLoans() {
            console.log('=== Load Current Loans Debug ===');
            
            const token = localStorage.getItem('access_token');
            console.log('Token:', token);
            
            if (!token) {
                console.log('No token found');
                document.getElementById('current-loans-result').innerHTML = '<p>Error: Authentication required. Please log in again.</p>';
                return;
            }
            
            console.log('Fetching current loans with JWT token');
            
            // Fetch current loans data - using the correct endpoint without member ID
            const url = `${baseUrl}/api/loan/`;
            console.log('Fetching current loans from:', url);
            
            fetch(url, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('Current loans API Response status:', response.status);
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Unauthorized: Please log in again');
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Current loans data received:', data);
                // Filter for loans that haven't been returned yet (is_return = 0)
                const currentLoans = data.filter(loan => loan.is_return === 0);
                
                if (currentLoans && currentLoans.length > 0) {
                    // Create HTML table for current loans
                    let tableHtml = `
                        <div class="result-card">
                            <h3>Current Loans</h3>
                            <table class="result-table">
                                <thead>
                                    <tr>
                                        <th>Item Code</th>
                                        <th>Title</th>
                                        <th>Loan Date</th>
                                        <th>Due Date</th>
                                        <th>Days Until Due</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    currentLoans.forEach(item => {
                        // Calculate days until due
                        const dueDate = new Date(item.due_date);
                        const today = new Date();
                        const timeDiff = dueDate.getTime() - today.getTime();
                        const daysUntilDue = Math.ceil(timeDiff / (1000 * 3600 * 24));
                        
                        tableHtml += `
                            <tr>
                                <td>${item.item_code || 'N/A'}</td>
                                <td>${item.title || 'N/A'}</td>
                                <td>${item.loan_date || 'N/A'}</td>
                                <td>${item.due_date || 'N/A'}</td>
                                <td>${daysUntilDue} days</td>
                            </tr>
                        `;
                    });
                    
                    tableHtml += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    document.getElementById('current-loans-result').innerHTML = tableHtml;
                    document.getElementById('current-loans-result').style.display = 'block';
                    document.getElementById('data-display').innerHTML = ''; // Clear main display
                } else {
                    document.getElementById('current-loans-result').innerHTML = '<p>No current loans found.</p>';
                    document.getElementById('current-loans-result').style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error loading current loans:', error);
                document.getElementById('current-loans-result').innerHTML = `<p>Error loading current loans: ${error.message}</p>`;
                document.getElementById('current-loans-result').style.display = 'block';
            });
        }

        // Function to load all books
        function loadAllBooks() {
            try {
                const token = localStorage.getItem('access_token');
                
                console.log('=== Load All Books Debug ===');
                console.log('Token:', token);
                
                if (!token) {
                    console.log('No token found, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }
                
                showStatus('Loading all books...');
                
                // Headers with authentication
                const headers = {
                    'Authorization': `Bearer ${token}`
                };
                
                // Fetch all books
                const url = `${baseUrl}/api/biblio/`;
                console.log('Fetching all books from:', url);
                console.log('Headers:', headers);
                
                fetch(url, { headers })
                    .then(response => {
                        console.log('Books API Response status:', response.status);
                        if (!response.ok) {
                            if (response.status === 401) {
                                console.log('Unauthorized, clearing tokens and redirecting to login');
                                localStorage.removeItem('access_token');
                                localStorage.removeItem('refresh_token');
                                localStorage.removeItem('username');
                                localStorage.removeItem('user_id');
                                window.location.href = 'login.html';
                                throw new Error('Authentication required');
                            }
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(books => {
                        console.log('Books data received:', books);
                        showStatus('Books loaded successfully!', false);
                        displayBooks(books);
                    })
                    .catch(error => {
                        console.error('Fetch error in loadAllBooks:', error);
                        if (error.message !== 'Authentication required') {
                            showStatus(`Error loading books: ${error.message}`, true);
                            document.getElementById('data-display').innerHTML = `<p>Error loading books: ${error.message}</p>`;
                        }
                    });
            } catch (error) {
                console.error('Error in loadAllBooks:', error);
                showStatus(`Script error: ${error.message}`, true);
            }
        }

        // Function to display account information
        function displayAccountInfo(member) {
            const container = document.getElementById('data-display');
            
            let html = `
                <div class="account-card">
                    <h2>üë§ Akun Saya</h2>
                    <div class="account-details">
                        <p><strong>Nama:</strong> ${member.member_name || 'N/A'}</p>
                        <p><strong>NIK:</strong> ${member.user_id || 'N/A'}</p>
                        <p><strong>Email:</strong> ${member.member_email || 'N/A'}</p>
                        <p><strong>Alamat:</strong> ${member.member_address || 'N/A'}</p>
                        <p><strong>Institusi:</strong> ${member.inst_name || 'N/A'}</p>
                        <p><strong>Tanggal Registrasi:</strong> ${member.register_date || 'N/A'}</p>
                        <p><strong>Tanggal Kadaluarsa:</strong> ${member.expire_date || 'N/A'}</p>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Function to display loan history
        function displayLoanHistory(loanHistory) {
            const container = document.getElementById('data-display');
            
            let loanData = [];
            if (Array.isArray(loanHistory)) {
                loanData = loanHistory;
            } else if (loanHistory.results && Array.isArray(loanHistory.results)) {
                loanData = loanHistory.results;
            } else {
                loanData = [loanHistory];
            }
            
            if (loanData.length === 0) {
                container.innerHTML = '<p>Tidak ada riwayat peminjaman.</p>';
                return;
            }
            
            let html = `
                <div class="loan-history-card">
                    <h2>üîÅ Sejarah Peminjaman</h2>
                    <div class="loan-history-grid">
            `;
            
            loanData.forEach(loan => {
                html += `
                    <div class="loan-history-item">
                        <p><strong>Kode Item:</strong> ${loan.item_code || 'N/A'}</p>
                        <p><strong>Judul:</strong> ${loan.title || 'N/A'}</p>
                        <p><strong>Tanggal Pinjam:</strong> ${formatDate(loan.loan_date) || 'N/A'}</p>
                        <p><strong>Tanggal Jatuh Tempo:</strong> ${formatDate(loan.due_date) || 'N/A'}</p>
                        <p><strong>Tanggal Kembali:</strong> ${formatDate(loan.return_date) || 'Belum dikembalikan'}</p>
                        <p><strong>Status:</strong> ${loan.return_date ? 'Dikembalikan' : 'Masih dipinjam'}</p>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Function to display current loans
        function displayCurrentLoans(loans) {
            const container = document.getElementById('data-display');
            
            if (loans.length === 0) {
                container.innerHTML = '<p>Tidak ada peminjaman saat ini.</p>';
                return;
            }
            
            let html = `
                <div class="current-loans-card">
                    <h2>üìö Peminjaman Saat Ini</h2>
                    <div class="current-loans-grid">
            `;
            
            loans.forEach(loan => {
                // Calculate days until due
                let daysUntilDue = 'N/A';
                if (loan.due_date) {
                    const dueDate = new Date(loan.due_date);
                    const today = new Date();
                    const timeDiff = dueDate.getTime() - today.getTime();
                    daysUntilDue = Math.ceil(timeDiff / (1000 * 3600 * 24));
                }
                
                html += `
                    <div class="current-loan-item">
                        <div class="loan-info">
                            <p><strong>Kode Item:</strong> ${loan.item_code || 'N/A'}</p>
                            <p><strong>Judul:</strong> ${loan.title || 'N/A'}</p>
                            <p><strong>Tanggal Pinjam:</strong> ${formatDate(loan.loan_date) || 'N/A'}</p>
                            <p><strong>Tanggal Jatuh Tempo:</strong> ${formatDate(loan.due_date) || 'N/A'}</p>
                            <p class="${daysUntilDue < 0 ? 'overdue' : daysUntilDue <= 3 ? 'due-soon' : ''}"><strong>Sisa Waktu:</strong> ${daysUntilDue > 0 ? daysUntilDue + ' hari lagi' : daysUntilDue === 0 ? 'Hari ini' : Math.abs(daysUntilDue) + ' hari terlambat'}</p>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // Helper function to format dates
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            
            const date = new Date(dateString);
            if (isNaN(date.getTime())) return dateString; // return original if invalid date
            
            // Format as YYYY-MM-DD to DD/MM/YYYY
            return dateString.split('-').reverse().join('/');
        }

        // Function to display all books
        function displayBooks(books) {
            const container = document.getElementById('data-display');
            
            let booksData = [];
            if (Array.isArray(books)) {
                booksData = books;
            } else if (books.results && Array.isArray(books.results)) {
                booksData = books.results;
            } else {
                booksData = [books];
            }
            
            if (booksData.length === 0) {
                container.innerHTML = '<p>Tidak ada buku tersedia.</p>';
                return;
            }
            
            let html = `
                <div class="all-books-card">
                    <h2>üìñ Semua Buku (${booksData.length})</h2>
                    <div class="books-grid">
            `;
            
            booksData.forEach(book => {
                html += `
                    <div class="book-item">
                        <h3>${book.title || 'Untitled Book'}</h3>
                        <p><strong>ISBN:</strong> ${book.isbn_issn || 'N/A'}</p>
                        <p><strong>Tahun Terbit:</strong> ${book.publish_year || 'N/A'}</p>
                        <p><strong>Edisi:</strong> ${book.edition || 'N/A'}</p>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
    </script>
</body>
</html>