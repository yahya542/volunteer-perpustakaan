<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Library Data Dashboard</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <h1>Library Data Dashboard</h1>
    
    <div class="container">
        <div style="text-align: right; margin-bottom: 20px;">
            <span id="user-info"></span>
            <button id="logout-btn" style="display: none;" onclick="logout()">Logout</button>
        </div>
        
        <h2>All Library Data</h2>
        <div class="endpoint-card">
            <button onclick="loadAllData()">Load All Data</button>
            <div id="status-message" style="margin: 10px 0; padding: 10px; border-radius: 5px; display: none;"></div>
            <div id="data-display" style="margin-top: 20px;"></div>
        </div>
    </div>

    <script>
        const baseUrl = 'http://localhost:8000';
        
        // Check authentication on page load
        document.addEventListener('DOMContentLoaded', function() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                // Redirect to login page if not authenticated
                window.location.href = 'login.html';
                return;
            }
            
            // Show user info and logout button
            const username = localStorage.getItem('username');
            document.getElementById('user-info').textContent = `Logged in as: ${username}`;
            document.getElementById('logout-btn').style.display = 'inline-block';
        });
        
        // Logout function
        function logout() {
            localStorage.removeItem('access_token');
            localStorage.removeItem('refresh_token');
            localStorage.removeItem('username');
            localStorage.removeItem('user_type');
            window.location.href = 'login.html';
        }

        // Function to show status messages
        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('status-message');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            statusDiv.style.backgroundColor = isError ? '#ffebee' : '#e8f5e9';
            statusDiv.style.border = `1px solid ${isError ? '#ffcdd2' : '#c8e6c9'}`;
            statusDiv.style.color = isError ? '#c62828' : '#2e7d32';
        }

        // Function to load all data
        function loadAllData() {
            const token = localStorage.getItem('access_token');
            if (!token) {
                window.location.href = 'login.html';
                return;
            }
            
            showStatus('Loading all library data...');
            
            // Headers with authentication
            const headers = {
                'Authorization': `Bearer ${token}`
            };
            
            // Load data from all available endpoints
            Promise.all([
                fetch(`${baseUrl}/api/biblio/?include_related=true`, { headers }),
                fetch(`${baseUrl}/api/loan-history/`, { headers }),
                fetch(`${baseUrl}/user/members/`, { headers }),
                fetch(`${baseUrl}/user/member-types/`, { headers }),
                fetch(`${baseUrl}/user/visitors/`, { headers }),
                fetch(`${baseUrl}/user/comments/`, { headers }),
                fetch(`${baseUrl}/auth/users/`, { headers }),
                fetch(`${baseUrl}/auth/user-groups/`, { headers }),
                fetch(`${baseUrl}/auth/group-access/`, { headers })
            ])
            .then(responses => Promise.all(responses.map(res => {
                if (!res.ok) {
                    if (res.status === 401) {
                        // Token expired or invalid, redirect to login
                        localStorage.removeItem('access_token');
                        localStorage.removeItem('refresh_token');
                        window.location.href = 'login.html';
                        throw new Error('Authentication required');
                    }
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                return res.json();
            })))
            .then(([books, loanHistory, members, memberTypes, visitors, comments, users, userGroups, groupAccess]) => {
                showStatus('All data loaded successfully!', false);
                displayAllData({ books, loanHistory, members, memberTypes, visitors, comments, users, userGroups, groupAccess });
            })
            .catch(error => {
                if (error.message !== 'Authentication required') {
                    console.error('Fetch error:', error);
                    showStatus(`Error loading data: ${error.message}`, true);
                    document.getElementById('data-display').innerHTML = `<p>Error loading data: ${error.message}</p>`;
                }
            });
        }

        // Function to display all data
        function displayAllData(data) {
            const container = document.getElementById('data-display');
            
            let html = `
                <div class="combined-card">
                    <h2>üìö Library Dashboard</h2>
                    
                    <!-- Books Section -->
                    <div class="data-section">
                        <h3>üìö Books (${getCount(data.books)})</h3>
                        ${displayBooks(data.books)}
                    </div>
                    
                    <!-- Loan History Section -->
                    <div class="data-section">
                        <h3>üîÅ Loan History (${getCount(data.loanHistory)})</h3>
                        ${displayLoanHistory(data.loanHistory)}
                    </div>
                    
                    <!-- Members Section -->
                    <div class="data-section">
                        <h3>üë• Members (${getCount(data.members)})</h3>
                        ${displayMembers(data.members)}
                    </div>
                    
                    <!-- Member Types Section -->
                    <div class="data-section">
                        <h3>üè∑Ô∏è Member Types (${getCount(data.memberTypes)})</h3>
                        ${displayMemberTypes(data.memberTypes)}
                    </div>
                    
                    <!-- Visitors Section -->
                    <div class="data-section">
                        <h3>üö∂ Visitors (${getCount(data.visitors)})</h3>
                        ${displayVisitors(data.visitors)}
                    </div>
                    
                    <!-- Comments Section -->
                    <div class="data-section">
                        <h3>üí¨ Comments (${getCount(data.comments)})</h3>
                        ${displayComments(data.comments)}
                    </div>
                    
                    <!-- Users Section -->
                    <div class="data-section">
                        <h3>üë§ Users (${getCount(data.users)})</h3>
                        ${displayUsers(data.users)}
                    </div>
                    
                    <!-- User Groups Section -->
                    <div class="data-section">
                        <h3>üë• User Groups (${getCount(data.userGroups)})</h3>
                        ${displayUserGroups(data.userGroups)}
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        // Helper function to get count from data
        function getCount(data) {
            if (Array.isArray(data)) {
                return data.length;
            } else if (data.results && Array.isArray(data.results)) {
                return data.results.length;
            } else if (typeof data === 'object' && data !== null) {
                return Object.keys(data).length;
            }
            return 0;
        }

        // Function to display books
        function displayBooks(books) {
            // Handle both array and paginated responses
            let booksData = [];
            if (Array.isArray(books)) {
                booksData = books;
            } else if (books.results && Array.isArray(books.results)) {
                booksData = books.results;
            } else {
                booksData = [books]; // Single book object
            }
            
            if (booksData.length === 0) {
                return '<p>No books found.</p>';
            }
            
            let html = `<div class="book-grid">`;
            
            booksData.forEach(book => {
                // Extract author information if available
                let authorDetails = '';
                if (book.authors && Array.isArray(book.authors) && book.authors.length > 0) {
                    authorDetails = '<p><strong>Authors:</strong></p><ul>';
                    book.authors.forEach(author => {
                        authorDetails += `<li>${author.author_name || 'Unknown Author'}</li>`;
                    });
                    authorDetails += '</ul>';
                } else {
                    authorDetails = '<p><strong>Authors:</strong> N/A</p>';
                }
                
                // Extract publisher information if available
                let publisherInfo = '';
                if (book.publisher) {
                    publisherInfo = `<p><strong>Publisher:</strong> ${book.publisher.publisher_name || 'N/A'}</p>`;
                }
                
                // Extract language information if available
                let languageInfo = '';
                if (book.language) {
                    languageInfo = `<p><strong>Language:</strong> ${book.language.language_name || 'N/A'}</p>`;
                }
                
                // Extract GMD information if available
                let gmdInfo = '';
                if (book.gmd) {
                    gmdInfo = `<p><strong>GMD:</strong> ${book.gmd.gmd_name || 'N/A'}</p>`;
                }
                
                html += `  
                    <div class="book-card">
                        <div class="book-header">
                            <h4>${book.title || 'Untitled Book'}</h4>
                        </div>
                        <div class="book-details">
                            ${book.image ? `<p><strong></strong><br><img src="/cover/${book.image}" alt="${book.title}" style="max-width: 200px; height: auto; margin-top: 10px;" onerror="this.onerror=null;this.src='/cover/${book.image}';"></p>` : ''}
                            <p><strong>Book ID:</strong> ${book.biblio_id || 'N/A'}</p>
                            <p><strong>Edition:</strong> ${book.edition || 'N/A'}</p>
                            <p><strong>ISBN:</strong> ${book.isbn_issn || 'N/A'}</p>
                            <p><strong>Publish Year:</strong> ${book.publish_year || 'N/A'}</p>
                            <p><strong>Classification:</strong> ${book.classification || 'N/A'}</p>
                            ${authorDetails}
                            ${publisherInfo}
                            ${languageInfo}
                            ${gmdInfo}
                            ${book.notes ? `<p><strong>Notes:</strong> ${book.notes}</p>` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `</div>`;
            return html;
        }

        // Function to display loan history
        function displayLoanHistory(loanHistory) {
            let loanData = [];
            if (Array.isArray(loanHistory)) {
                loanData = loanHistory;
            } else if (loanHistory.results && Array.isArray(loanHistory.results)) {
                loanData = loanHistory.results;
            } else {
                loanData = [loanHistory];
            }
            
            if (loanData.length === 0) {
                return '<p>No loan history found.</p>';
            }
            
            let html = `<div class="loan-grid">`;
            loanData.forEach(loan => {
                html += `
                    <div class="loan-card">
                        <p><strong>Item Code:</strong> ${loan.item_code || 'N/A'}</p>
                        <p><strong>Member ID:</strong> ${loan.member_id || 'N/A'}</p>
                        <p><strong>Loan Date:</strong> ${loan.loan_date || 'N/A'}</p>
                        <p><strong>Due Date:</strong> ${loan.due_date || 'N/A'}</p>
                        <p><strong>Status:</strong> ${loan.return_date ? 'Returned' : 'Loaned'}</p>
                    </div>
                `;
            });
            html += `</div>`;
            return html;
        }

        // Function to display members
        function displayMembers(members) {
            let membersData = [];
            if (Array.isArray(members)) {
                membersData = members;
            } else if (members.results && Array.isArray(members.results)) {
                membersData = members.results;
            } else {
                membersData = [members];
            }
            
            if (membersData.length === 0) {
                return '<p>No members found.</p>';
            }
            
            let html = `<div class="members-grid">`;
            membersData.forEach(member => {
                html += `
                    <div class="member-card">
                        <h4>${member.member_name || 'Unnamed Member'}</h4>
                        <p><strong>Member ID:</strong> ${member.member_id || 'N/A'}</p>
                        <p><strong>Email:</strong> ${member.member_email || 'N/A'}</p>
                        <p><strong>Institution:</strong> ${member.inst_name || 'N/A'}</p>
                        <p><strong>Register Date:</strong> ${member.register_date || 'N/A'}</p>
                    </div>
                `;
            });
            html += `</div>`;
            return html;
        }

        // Function to display member types
        function displayMemberTypes(memberTypes) {
            let typesData = [];
            if (Array.isArray(memberTypes)) {
                typesData = memberTypes;
            } else if (memberTypes.results && Array.isArray(memberTypes.results)) {
                typesData = memberTypes.results;
            } else {
                typesData = [memberTypes];
            }
            
            if (typesData.length === 0) {
                return '<p>No member types found.</p>';
            }
            
            let html = `<div class="member-types-grid">`;
            typesData.forEach(type => {
                html += `
                    <div class="member-type-card">
                        <h4>${type.member_type_name || 'Unnamed Type'}</h4>
                        <p><strong>Loan Limit:</strong> ${type.loan_limit || 'N/A'}</p>
                        <p><strong>Loan Period:</strong> ${type.loan_periode || 'N/A'} days</p>
                        <p><strong>Fine Per Day:</strong> ${type.fine_each_day || 'N/A'}</p>
                    </div>
                `;
            });
            html += `</div>`;
            return html;
        }

        // Function to display visitors
        function displayVisitors(visitors) {
            let visitorsData = [];
            if (Array.isArray(visitors)) {
                visitorsData = visitors;
            } else if (visitors.results && Array.isArray(visitors.results)) {
                visitorsData = visitors.results;
            } else {
                visitorsData = [visitors];
            }
            
            if (visitorsData.length === 0) {
                return '<p>No visitors found.</p>';
            }
            
            let html = `<div class="visitors-grid">`;
            visitorsData.forEach(visitor => {
                html += `
                    <div class="visitor-card">
                        <h4>${visitor.member_name || 'Anonymous Visitor'}</h4>
                        <p><strong>Institution:</strong> ${visitor.institution || 'N/A'}</p>
                        <p><strong>Check-in Date:</strong> ${visitor.checkin_date || 'N/A'}</p>
                    </div>
                `;
            });
            html += `</div>`;
            return html;
        }

        // Function to display comments
        function displayComments(comments) {
            let commentsData = [];
            if (Array.isArray(comments)) {
                commentsData = comments;
            } else if (comments.results && Array.isArray(comments.results)) {
                commentsData = comments.results;
            } else {
                commentsData = [comments];
            }
            
            if (commentsData.length === 0) {
                return '<p>No comments found.</p>';
            }
            
            let html = `<div class="comments-grid">`;
            commentsData.forEach(comment => {
                html += `
                    <div class="comment-card">
                        <p><strong>Comment:</strong> ${comment.comment || 'No comment'}</p>
                        <p><strong>Member ID:</strong> ${comment.member_id || 'N/A'}</p>
                        <p><strong>Date:</strong> ${comment.input_date || 'N/A'}</p>
                    </div>
                `;
            });
            html += `</div>`;
            return html;
        }

        // Function to display users
        function displayUsers(users) {
            let usersData = [];
            if (Array.isArray(users)) {
                usersData = users;
            } else if (users.results && Array.isArray(users.results)) {
                usersData = users.results;
            } else {
                usersData = [users];
            }
            
            if (usersData.length === 0) {
                return '<p>No users found.</p>';
            }
            
            let html = `<div class="users-grid">`;
            usersData.forEach(user => {
                html += `
                    <div class="user-card">
                        <h4>${user.realname || 'Unnamed User'}</h4>
                        <p><strong>Username:</strong> ${user.username || 'N/A'}</p>
                        <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                        <p><strong>User Type:</strong> ${user.user_type || 'N/A'}</p>
                    </div>
                `;
            });
            html += `</div>`;
            return html;
        }

        // Function to display user groups
        function displayUserGroups(userGroups) {
            let groupsData = [];
            if (Array.isArray(userGroups)) {
                groupsData = userGroups;
            } else if (userGroups.results && Array.isArray(userGroups.results)) {
                groupsData = userGroups.results;
            } else {
                groupsData = [userGroups];
            }
            
            if (groupsData.length === 0) {
                return '<p>No user groups found.</p>';
            }
            
            let html = `<div class="user-groups-grid">`;
            groupsData.forEach(group => {
                html += `
                    <div class="user-group-card">
                        <h4>${group.group_name || 'Unnamed Group'}</h4>
                    </div>
                `;
            });
            html += `</div>`;
            return html;
        }

        // Load all data when page loads
        window.onload = function() {
            // Authentication check is handled in DOMContentLoaded event
            // Load data after authentication is confirmed
        };
    </script>
</body>
</html>